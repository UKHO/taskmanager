trigger:
  branches:
    include:
    - master
    - features/*
  paths:
    include:
    - src/Databases/NCNEWorkflowDatabase/*

stages:
- stage: Build
  jobs:
    - job: RestoreBuildAndDeploy
      pool: "UKHO Windows 2019"

      workspace:
          clean: all

      steps:
      - task: UseDotNet@2
        displayName: 'Use .NET Core 3.1 sdk'
        inputs:
          packageType: sdk
          version: 3.1.x
          installationPath: $(Agent.ToolsDirectory)\\dotnet

      - task: PowerShell@2
        inputs:
          targetType: 'inline'
          script: |
            Write-Host "Get sqlserver module"
            Install-Module "sqlserver" -Scope CurrentUser -Repository "PSGallery" -Force
            Import-Module "sqlserver"
            
            Write-Host "Drop localdb"
            Invoke-Sqlcmd `
            -Query $("DROP DATABASE [$env:LOCAL_DATABASE_NAME]") `
            -ServerInstance "(localdb)\MSSQLLocalDB"
          pwsh: true
        env:
          LOCAL_DATABASE_NAME: $(LocalDatabaseName)
        displayName: 'Drop localdb'

      - task: VSBuild@1
        inputs:
          solution: '$(Build.SourcesDirectory)\\src\\Databases\\NCNEWorkflowDatabase\\NCNEWorkflowDatabase.sqlproj'
          msbuildArgs: /t:Build;Publish /p:SqlPublishProfilePath=NCNEWorkflowDatabase.publish.xml
        displayName: 'Build NCNE WorkflowDatabase and publish to LocalDb'

      - task: DotNetCoreCLI@2
        inputs:
          command: 'test'
          projects: '$(Build.SourcesDirectory)\\src\\Databases\\NCNEWorkflowDatabase.Tests\\NCNEWorkflowDatabase.Tests.csproj'
        displayName: 'dotnet NCNE test LocalDb instance of database'

      - task: VSBuild@1
        inputs:
          solution: '$(Build.SourcesDirectory)\\src\\Databases\\NCNEWorkflowDatabase\\NCNEWorkflowDatabase.sqlproj'
        displayName: 'Build NCNE WorkflowDatabase Dacpac'

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.SourcesDirectory)\\src\\Databases\\NCNEWorkflowDatabase\\bin\\debug\\NCNEWorkflowDatabase.dacpac'
          ArtifactName: 'ncneworkflowdatabase'
          publishLocation: 'Container'
        displayName: 'Publish NCNE WorkflowDatabase'

- stage: DeployDev
  dependsOn: Build
  jobs:
    - deployment: DeployNCNEWorkflowDatabaseDev
      displayName: Deploy NCNEWorkflowDatabase
      pool: "NautilusRelease"
      environment: 'TaskmanagerDev'
      strategy:
        runOnce:
          deploy:
            steps:
              - task: SqlAzureDacpacDeployment@1
                inputs:
                  # azureSubscription: 'TM2 Dev/Test Sub Dev RG'
                  azureSubscription: 'SharedServicesPre'
                  ServerName: '$(ServerNameDev)'
                  DatabaseName: '$(DatabaseNameDev)'
                  SqlUsername: '$(SQLUsernameDev)'
                  SqlPassword: '$(SQLPasswordDev)'
                  DacpacFile: '$(Pipeline.Workspace)/ncneworkflowdatabase/NCNEWorkflowDatabase.dacpac'

- stage: DeployUAT
  dependsOn: Build
  jobs:
    - deployment: DeployNCNEWorkflowDatabaseUAT
      displayName: Deploy NCNEWorkflowDatabase
      pool: "NautilusRelease"
      environment: 'TaskmanagerUAT'
      strategy:
        runOnce:
          deploy:
            steps:
              - task: SqlAzureDacpacDeployment@1
                inputs:
                  # azureSubscription: 'TM2 Dev/Test Sub Dev RG'
                  azureSubscription: 'SharedServicesPre'
                  ServerName: '$(ServerNameUAT)'
                  DatabaseName: '$(DatabaseNameUAT)'
                  SqlUsername: '$(SQLUsernameUAT)'
                  SqlPassword: '$(SQLPasswordUAT)'
                  DacpacFile: '$(Pipeline.Workspace)/ncneworkflowdatabase/NCNEWorkflowDatabase.dacpac'

- stage: DeployPre
  dependsOn: Build
  jobs:
    - deployment: DeployNCNEWorkflowDatabasePre
      displayName: Deploy NCNEWorkflowDatabase
      pool: "NautilusRelease"
      environment: 'TaskmanagerPre'
      strategy:
        runOnce:
          deploy:
            steps:
              - task: SqlAzureDacpacDeployment@1
                inputs:
                  # azureSubscription: 'TM2 Dev/Test Sub Dev RG'
                  azureSubscription: 'SharedServicesPre'
                  ServerName: '$(ServerNamePre)'
                  DatabaseName: '$(DatabaseNamePre)'
                  SqlUsername: '$(SQLUsernamePre)'
                  SqlPassword: '$(SQLPasswordPre)'
                  DacpacFile: '$(Pipeline.Workspace)/ncneworkflowdatabase/NCNEWorkflowDatabase.dacpac'
